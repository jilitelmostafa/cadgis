<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>CadGIS + Tableau Provinces</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css" />
<script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
<style>
html, body{
  margin:0; padding:0;
  height:100%;
  overflow:hidden;
  font-family:Arial, sans-serif;
}
#app{
  height:100vh;
  display:flex;
  flex-direction:column;
}
#header{
  flex-shrink:0;
  background:linear-gradient(135deg,#E49112 0%,#1B5B9A 100%);
  color:#fff;
  text-align:center;
  padding:12px 10px;
  font-size:clamp(14px,4vw,22px);
  font-weight:bold;
  box-shadow:0 4px 6px rgba(0,0,0,0.1);
}
#content{
  position:relative;
  flex:1;
  overflow:hidden;
}
#map{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}

/* Popup */
.ol-popup{
  background:linear-gradient(135deg,#ffffff 0%,#f5f7fb 100%);
  padding:14px 16px;
  border:1px solid #e0e4ef;
  min-width:200px;
  max-width:90vw;
  z-index:9999;
  font-size:13px;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(15,23,42,0.18);
  color:#1f2933;
}
.ol-popup b{font-size:14px;color:#111827;}
.ol-popup a,
.ol-popup button{
  display:inline-block;
  margin-top:6px;
  padding:6px 10px;
  background:#dc2626;
  color:#fff;
  border:none;
  border-radius:6px;
  text-decoration:none;
  font-size:12px;
  cursor:pointer;
  margin-right:5px;
}
.ol-popup a:hover,
.ol-popup button:hover{background:#b91c1c;}
.ol-popup .request-btn{background:#9333ea;}
.ol-popup .request-btn:hover{background:#7e22ce;}
.ol-popup .download-btn{background:#4CAF50;}
.ol-popup .download-btn:hover{background:#388E3C;}

/* Ø£Ø²Ø±Ø§Ø± ØªÙˆØ§ØµÙ„ */
#contactButtons{
  position:absolute;
  right:10px;
  bottom:10px;
  z-index:2300;
  display:flex;
  flex-direction:column;
  gap:6px;
}
#contactButtons a{
  width:34px;
  height:34px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#111827;
  color:#fff;
  text-decoration:none;
  font-size:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.18);
}
#contactButtons a:hover{opacity:0.85;}

/* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© */
#basemapToggle{
  position:absolute;
  top:10px;
  right:250px;
  z-index:2100;
  padding:6px 10px;
  font-size:12px;
  border-radius:6px;
  border:none;
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}
#basemapToggle:hover{background:#1d4ed8;}

/* Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ */
#toggleProv{
  position:absolute;
  left:10px;
  top:10px;
  z-index:2600;
  padding:6px 10px;
  font-size:12px;
  border-radius:6px;
  border:none;
  background:#111827;
  color:#fff;
  cursor:pointer;
  display:none;
}

/* Ø¨Ø­Ø« OSM Ø¨Ø³ÙŠØ· */
#searchContainer{
  position:absolute;
  top:10px;
  right:10px;
  z-index:2000;
  display:flex;
  flex-direction:column;
}
#searchBoxOSM{
  width:220px;
  padding:6px 10px;
  font-size:13px;
  border-radius:20px;
  border:1px solid #ccc;
  outline:none;
}
#searchBoxOSM:focus{border-color:#2563eb;}
#suggestions{
  margin-top:2px;
  width:220px;
  max-height:150px;
  overflow-y:auto;
  padding:0;
  list-style:none;
  border:1px solid #ccc;
  background:#fff;
  border-radius:6px;
  display:none;
  font-size:13px;
}
#suggestions li{padding:6px 10px;cursor:pointer;}
#suggestions li:hover{background:#f0f0f0;}
@media(max-width:768px){
  #searchBoxOSM,#suggestions{width:160px;}
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ø¯ÙˆÙ„ + ØªÙ…Ø±ÙŠØ± Ø±Ø£Ø³ÙŠ + Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·ÙŠ */
#prov-container{
  position:absolute;
  left:10px;
  top:60px;
  z-index:2500;
  background:rgba(255,255,255,0.9);
  padding:10px 12px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.18);
  max-height:70vh;
  font-size:12px;
  min-width:340px;
  display:flex;
  flex-direction:column;
}
#prov-container h2{
  margin:0 0 8px 0;
  font-size:14px;
}
#prov-filters{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:8px;
}
#prov-filters select,
#prov-filters input{
  padding:3px 6px;
  font-size:12px;
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
#prov-scroll-wrapper{
  max-height:55vh;
  overflow-y:auto;
  overflow-x:hidden;
}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª */
#prov-table{
  border-collapse:collapse;
  width:100%;
}
#prov-table th,
#prov-table td{
  border:1px solid #ddd;
  padding:4px 6px;
}
#prov-table th{
  background:#f3f4f6;
}
#prov-table tbody tr:nth-child(even){
  background:rgba(250,250,250,0.9);
}
#prov-table tbody tr.highlight{
  background:#fffbdd !important;
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©: Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒÙ„ÙˆØ­Ø© Ø³ÙÙ„ÙŠØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ */
@media(max-width:768px){
  #prov-container{
    left:0;
    right:0;
    top:auto;
    bottom:0;
    margin:0 auto;
    max-height:55vh;
    width:96vw;
    max-width:96vw;
    font-size:11px;
    background:#f9fafb;
    border-radius:14px 14px 0 0;
    box-shadow:0 -4px 18px rgba(0,0,0,0.22);
    border:1px solid #e5e7eb;
    display:none;
  }
  #toggleProv{
    display:block;
  }
  #prov-scroll-wrapper{
    max-height:45vh;
  }
}

/* Ø¨ÙˆØªÙˆÙ… Ø´ÙŠØª Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± (Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµÙˆØ± Ø¨Ø¯Ù„ ÙˆØ§ØªØ³Ø§Ø¨) */
#img-preview-sheet{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  z-index:2600;
  transition:bottom 0.35s ease;
}
#img-preview-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.45);
  opacity:0;
  pointer-events:none;
  transition:opacity 0.25s ease;
  z-index:2590;
}
#img-preview-sheet.active{
  bottom:0;
}
#img-preview-overlay.active{
  opacity:1;
  pointer-events:auto;
}
#img-preview-content{
  margin:0 auto;
  max-width:520px;
  width:100%;
  background:#0b1120;
  border-radius:16px 16px 0 0;
  box-shadow:0 -8px 30px rgba(0,0,0,0.45);
  padding:10px 10px 12px 10px;
  color:#e5e7eb;
}
#img-preview-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
#img-preview-header span.title{
  font-size:13px;
  font-weight:bold;
}
#img-preview-close{
  background:none;
  border:none;
  color:#9ca3af;
  cursor:pointer;
  font-size:16px;
}
#img-preview-close:hover{color:#e5e7eb;}

/* Ø³Ù„Ø§ÙŠØ¯Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ØµÙˆØ± */
#img-preview-slider{
  position:relative;
  overflow:hidden;
  border-radius:10px;
  background:#020617;
}
.img-slide-track{
  display:flex;
  transition:transform 0.45s ease;
}
.img-slide{
  min-width:100%;
}
.img-slide img{
  width:100%;
  max-height:260px;
  object-fit:cover;
  display:block;
}
#img-preview-dots{
  display:flex;
  justify-content:center;
  gap:4px;
  margin-top:6px;
}
#img-preview-dots button{
  width:7px;
  height:7px;
  border-radius:999px;
  border:none;
  background:#4b5563;
  padding:0;
  cursor:pointer;
}
#img-preview-dots button.active{
  background:#22c55e;
}
#img-preview-footer{
  margin-top:6px;
  font-size:11px;
  color:#cbd5f5;
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠÙƒÙˆÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆØªÙˆÙ… Ø´ÙŠØª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
@media(max-width:600px){
  #img-preview-content{
    border-radius:14px 14px 0 0;
  }
}

/* Ø§Ø±ØªÙØ§Ø¹Ø§Øª ØµØºÙŠØ±Ø© */
@media(max-height:550px){
  #app{
    height:auto;
    min-height:100vh;
  }
}
</style>
</head>
<body>
<div id="app">
<header id="header">
  CadGIS | Titres fonciers | Bornes | Zonage | Limites ADM
</header>

<main id="content">
  <div id="map"></div>

  <!-- Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <button id="toggleProv">â˜° Provinces</button>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… Ù…Ø¹ ÙÙ„Ø§ØªØ± + ØªÙ…Ø±ÙŠØ± Ø±Ø£Ø³ÙŠ -->
  <div id="prov-container">
    <h2>Filtres Provinces</h2>
    <div id="prov-filters">
      <input type="text" id="filterProv" placeholder="ğŸ” Filtrer par Province">
      <select id="filterRegion">
        <option value="">Toutes les rÃ©gions</option>
        <option value="Casablanca-Settat">Casablanca-Settat</option>
        <option value="Marrakech-Safi">Marrakech-Safi</option>
        <option value="Rabat-SalÃ©-KÃ©nitra">Rabat-SalÃ©-KÃ©nitra</option>
        <option value="FÃ¨s-MeknÃ¨s">FÃ¨s-MeknÃ¨s</option>
        <option value="Souss-Massa">Souss-Massa</option>
        <option value="BÃ©ni Mellal-KhÃ©nifra">BÃ©ni Mellal-KhÃ©nifra</option>
        <option value="Oriental">Oriental</option>
        <option value="DrÃ¢a-Tafilalet">DrÃ¢a-Tafilalet</option>
        <option value="Guelmim-Oued Noun">Guelmim-Oued Noun</option>
        <option value="LaÃ¢youne-Sakia El Hamra">LaÃ¢youne-Sakia El Hamra</option>
        <option value="Dakhla-Oued Ed-Dahab">Dakhla-Oued Ed-Dahab</option>
        <option value="Tanger-TÃ©touan-Al HoceÃ¯ma">Tanger-TÃ©touan-Al HoceÃ¯ma</option>
      </select>
    </div>
    <div id="prov-scroll-wrapper">
      <table id="prov-table">
        <thead>
          <tr>
            <th>Province</th>
            <th>RÃ©gion</th>
            <th>Nom Arabe</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody id="provTableBody">
          <!-- ÙŠÙÙ…Ù„Ø£ Ø¨Ø§Ù„Ù€JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØªÙˆØ§ØµÙ„ (Email + Photos) -->
  <div id="contactButtons">
    <a href="mailto:contact@cartomaroc.com" id="mailBtn" title="Email">âœ‰</a>
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© ØµÙˆØ± Ø¨Ø¯Ù„ ÙˆØ§ØªØ³Ø§Ø¨ -->
    <a href="javascript:void(0)" id="imgBtn" title="AperÃ§u images">ğŸ–¼ï¸</a>
  </div>

  <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
  <button id="basemapToggle">ğŸ—ºï¸ OSM</button>

  <!-- Ø¨Ø­Ø« OSM Ø¨Ø³ÙŠØ· -->
  <div id="searchContainer">
    <input type="text" id="searchBoxOSM" placeholder="ğŸ” Rechercher..." />
    <ul id="suggestions"></ul>
  </div>

  <div id="popup" class="ol-popup"></div>
</main>
</div>

<!-- Ø¨ÙˆØªÙˆÙ… Ø´ÙŠØª Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ± -->
<div id="img-preview-overlay"></div>
<div id="img-preview-sheet">
  <div id="img-preview-content">
    <div id="img-preview-header">
      <span class="title">AperÃ§u de la plateforme CadGIS</span>
      <button id="img-preview-close" aria-label="Fermer">âœ–</button>
    </div>
    <div id="img-preview-slider">
      <div class="img-slide-track" id="img-slide-track">
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgr5KFsKULUeoG4mQ3x8lC1YweUxmNIlz-oGR1WwhIh9L2ijtpAp5ul8Bb-t7kSkDHf_USvqBjfl4OWiUGecby0QD6jv5inCDvukxSv-WG_4-1AOeH1qjbyeixSpXRZ6bjXPehHipekRFU2hBprRSvTBhcRolFc1IUD3MPXcXZfB5A8SaupmRCDpgM16BA/s1057/Capture%20d%27%C3%A9cran%202026-01-06%20014516.png" alt="">
        </div>
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhe3_gUcJiHw9LrojEFoi-ZfOl0zJKJBYRpgGryK1WWnZM37SxrF71QzK-1Gj_ormUAqgeegdZWu1VNBUAxwsqoWhYkeq0YEostRYzmW7VdhtIHC8G0BoG_rCBaH2nUF54ZcAjjOvo2th75QT9zZGc6Jo-l7c1R163suf3aaMCIGkEOXex0slPr9hIu6fE/s1699/Capture%20d%27%C3%A9cran%202026-01-03%20174608.png" alt="">
        </div>
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhri0io4hMto214bOss-K46MeA5-g6l_0hK9n1RqBcQMlvySALg8ji54NLECgZKx84OvRdpYkpnkbZB0c8xZMAQHoRQ_MYn_ShtQytNYrP36gqpbjjZeWCwBh-jeHwcm4UYlqQwhwZrYO4KE8Lr80JZLlwte_oUwR_0q5_gbmURMjppIvMG4J-DQriIM6U/s1919/Capture%20d%27%C3%A9cran%202026-01-03%20171837.png" alt="">
        </div>
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7xbKzQ0ln970U5o-QfKL7PHcLBhAmhp-YbIG0OWBz8IiklghL2jKsCA5h9rCcu__dyOFJbN33_TRNv6CNHSH0R1Fs7LzGVZP3N44wtY6a4qv9wHcIjPrftK3a3ijBW3xulFce09Umk0uTtlwrRCoflFUbTr8YEErhZHxDNeRxaHL71PfYjSvWtLCq5Xw/s1919/Capture%20d%27%C3%A9cran%202026-01-03%20171720.png" alt="">
        </div>
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiNXa2p6GEkdaVzReJWx_IN6aE27LworRm7AuZyXG0PkkHXiAfdOibKIWgiNXQp_Ws-R1H7Y7k4O7TI2HoZloT8SXZQpG0AKBrKSy9-zmuzBoL0cd18ACMq2HDjQcfhVCvQwW5pDtbLkFqvvJBzSp2WviK1YepYPyK0LUfd38r5QeHpBvlvF_NOewKElbM/s1617/Capture%20d%27%C3%A9cran%202026-01-03%20171613.png" alt="">
        </div>
        <div class="img-slide">
          <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_1fRa6tP7QeDIhaI8ck4rrq5-eGnncDt6e5Jgjg9M0EewKTncRjqF5bOh3hBw4vyuqS-sEATO2mJwA5oyxxgCQ1gpRC5wdQAE9VZBK7w6U3EHdgZNgG9RP7dDfu1zddU02Tz0oq2RBhadSeQZ2XaFTXaDxJVC_WdM8IPUnfQuKEMxvkwTLBaI1MjMPRU/s1634/Capture%20d%27%C3%A9cran%202026-01-03%20171419.png" alt="">
        </div>
      </div>
    </div>
    <div id="img-preview-dots">
      <button data-index="0" class="active"></button>
      <button data-index="1"></button>
      <button data-index="2"></button>
      <button data-index="3"></button>
      <button data-index="4"></button>
      <button data-index="5"></button>
    </div>
    <div id="img-preview-footer">
      AperÃ§u rapide des fonctionnalitÃ©s: titres fonciers, bornes, zonage et limites administratives.
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const geojsonSource = new ol.source.Vector({
    url: "https://ia601703.us.archive.org/6/items/prov_ma_202601/prov_ma.txt",
    format: new ol.format.GeoJSON()
  });

  function getProvinceName(feature) {
    const props = feature.getProperties();
    const possible = ["NOM-PROV","NOM_PROV","name","NAME","nom","Nom","Ø§Ù„Ø§Ù‚Ù„ÙŠÙ…","Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…"];
    for (let f of possible) if (props[f]) return props[f];
    return "Sans nom";
  }

  const provinceToRegion = {/* Ù†ÙØ³ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø°ÙŠ ØªØ³ØªØ¹Ù…Ù„Ù‡ */};
  const provinceDownloadLinks = {/* Ù†ÙØ³ ÙƒØ§Ø¦Ù† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ */};

  const geojsonLayer = new ol.layer.Vector({
    source: geojsonSource,
    style: function (feature) {
      return new ol.style.Style({
        stroke: new ol.style.Stroke({ color: "black", width: 1.3 }),
        fill: new ol.style.Fill({ color: "rgba(244, 67, 54, 0.1)" }),
        text: new ol.style.Text({
          text: getProvinceName(feature),
          font: "bold 12px Arial",
          fill: new ol.style.Fill({ color: "#000" }),
          stroke: new ol.style.Stroke({ color: "#fff", width: 2 })
        })
      });
    }
  });

  const osmStandard = new ol.layer.Tile({ source:new ol.source.OSM(), visible:true });
  const esriImagery = new ol.layer.Tile({
    source:new ol.source.XYZ({
      url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
    }),
    visible:false
  });
  const satLike = new ol.layer.Tile({
    source:new ol.source.XYZ({
      url:"https://tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"
    }),
    visible:false
  });

  const map = new ol.Map({
    target:"map",
    layers:[osmStandard, esriImagery, satLike, geojsonLayer],
    view:new ol.View({
      center:ol.proj.fromLonLat([-7.9,31.6]),
      zoom:6
    })
  });

  const selectInteraction = new ol.interaction.Select({
    layers:[geojsonLayer],
    style:function(feature){
      return new ol.style.Style({
        stroke:new ol.style.Stroke({color:"#facc15",width:2.5}),
        fill:new ol.style.Fill({color:"rgba(250,204,21,0.45)"}),
        text:new ol.style.Text({
          text:getProvinceName(feature),
          font:"bold 12px Arial",
          fill:new ol.style.Fill({color:"#000"}),
          stroke:new ol.style.Stroke({color:"#fff",width:2})
        })
      });
    }
  });
  map.addInteraction(selectInteraction);

  const popup = new ol.Overlay({
    element:document.getElementById("popup"),
    positioning:"bottom-center",
    offset:[0,-15]
  });
  map.addOverlay(popup);

  window.downloadProvinceData = function (provinceName) {
    const link = provinceDownloadLinks[provinceName];
    if (link) window.open(link,"_blank");
    else alert("âš ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…");
  };

  function showPopup(feature, coord){
    const nomFr = feature.get("NOM_PROV") || getProvinceName(feature);
    const nomAr = feature.get("nomArabic") || "";
    let html = `
      <b>${nomFr}</b><br>
      <span style="font-weight:bold; color:#FF0000;">
      Titres fonciers | Bornes | Zonage | ${nomAr}
      </span><br>
      â„¹ï¸ DonnÃ©es disponibles sur demande<br>
      <button class="request-btn" onclick="downloadProvinceData('${nomFr}')">
      ğŸ“± Demander ces donnÃ©es
      </button><br><br>
      <a href="mailto:contact@cartomaroc.com">contact@cartomaroc.com</a>
    `;
    popup.getElement().innerHTML = html;
    popup.setPosition(coord);
  }

  map.on("click",(evt)=>{
    const f = map.forEachFeatureAtPixel(evt.pixel,ft=>ft);
    if(f){
      showPopup(f,evt.coordinate);
      selectInteraction.getFeatures().clear();
      selectInteraction.getFeatures().push(f);
    }else{
      popup.setPosition(undefined);
      selectInteraction.getFeatures().clear();
    }
  });

  const basemapBtn = document.getElementById("basemapToggle");
  const basemaps = [
    {layer:osmStandard,label:"OSM"},
    {layer:esriImagery,label:"Esri"},
    {layer:satLike,label:"Sat"}
  ];
  let currentBase = 0;
  function setBasemap(i){
    basemaps.forEach((b,idx)=>b.layer.setVisible(idx===i));
    basemapBtn.textContent = "ğŸ—ºï¸ " + basemaps[i].label;
  }
  basemapBtn.addEventListener("click",()=>{
    currentBase = (currentBase+1)%basemaps.length;
    setBasemap(currentBase);
  });
  setBasemap(0);

  const searchBox = document.getElementById("searchBoxOSM");
  const suggestions = document.getElementById("suggestions");
  searchBox.addEventListener("input",function(){
    const query=this.value.trim();
    if(!query){suggestions.style.display="none";return;}
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query+", Maroc")}&limit=5`)
    .then(res=>res.json())
    .then(data=>{
      suggestions.innerHTML="";
      if(data.length>0){
        data.forEach(item=>{
          const li=document.createElement("li");
          li.textContent=item.display_name;
          li.addEventListener("click",()=>{
            const lon=parseFloat(item.lon);
            const lat=parseFloat(item.lat);
            map.getView().animate({
              center:ol.proj.fromLonLat([lon,lat]),
              zoom:12,
              duration:1000
            });
            suggestions.style.display="none";
            searchBox.value=item.display_name;
          });
          suggestions.appendChild(li);
        });
        suggestions.style.display="block";
      }else{
        suggestions.style.display="none";
      }
    }).catch(err=>console.error(err));
  });
  document.addEventListener("click",(e)=>{
    if(e.target!==searchBox) suggestions.style.display="none";
  });

  const filterProvInput = document.getElementById("filterProv");
  const filterRegionSelect = document.getElementById("filterRegion");
  const provTableBody = document.getElementById("provTableBody");

  geojsonSource.once("change",function(){
    if(geojsonSource.getState()==="ready"){
      fillProvTable();
    }
  });

  function fillProvTable(){
    provTableBody.innerHTML="";
    const features = geojsonSource.getFeatures();
    const added = new Set();
    features.forEach(ft=>{
      const nomFr = ft.get("NOM_PROV") || getProvinceName(ft);
      if(added.has(nomFr)) return;
      added.add(nomFr);
      const nomAr = ft.get("nomArabic") || "â€”";
      const region = provinceToRegion[nomFr] || "â€”";
      const downloadLink = provinceDownloadLinks[nomFr] || null;
      const tr = document.createElement("tr");
      tr.dataset.province = nomFr;
      tr.dataset.region = region;
      tr.dataset.nomAr = nomAr;
      tr.innerHTML = `
        <td>${nomFr}</td>
        <td>${region}</td>
        <td>${nomAr}</td>
        <td style="text-align:center;">
          ${downloadLink ? `<a href="${downloadLink}" target="_blank">TÃ©lÃ©charger</a>` : "âœ‰ï¸"}
        </td>
      `;
      provTableBody.appendChild(tr);
    });
  }

  function applyTableFilters(){
    const txt = filterProvInput.value.trim().toLowerCase();
    const reg = filterRegionSelect.value;
    const rows = provTableBody.querySelectorAll("tr");
    rows.forEach(r=>{
      const prov = r.dataset.province.toLowerCase();
      const nomAr = (r.dataset.nomAr || "").toLowerCase();
      const region = r.dataset.region;
      const matchText = !txt || prov.includes(txt) || nomAr.includes(txt);
      if(!txt){
        const matchRegion = !reg || region === reg;
        r.style.display = matchRegion ? "" : "none";
      }else{
        r.style.display = matchText ? "" : "none";
      }
    });
  }
  filterProvInput.addEventListener("keyup",applyTableFilters);
  filterRegionSelect.addEventListener("change",applyTableFilters);

  // Ø²Ø± ÙØªØ­/Ø·ÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
  const toggleProvBtn = document.getElementById("toggleProv");
  const provContainer = document.getElementById("prov-container");
  if(toggleProvBtn && provContainer){
    toggleProvBtn.addEventListener("click",()=>{
      if (getComputedStyle(provContainer).display === "none"){
        provContainer.style.display = "flex";
        toggleProvBtn.textContent = "âœ– Fermer";
      }else{
        provContainer.style.display = "none";
        toggleProvBtn.textContent = "â˜° Provinces";
      }
    });
  }

  /* ====== Ø¨ÙˆØªÙˆÙ… Ø´ÙŠØª Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± ====== */
  const imgBtn = document.getElementById("imgBtn");
  const sheet = document.getElementById("img-preview-sheet");
  const overlay = document.getElementById("img-preview-overlay");
  const closeBtn = document.getElementById("img-preview-close");
  const track = document.getElementById("img-slide-track");
  const dots = document.querySelectorAll("#img-preview-dots button");
  let currentIndex = 0;
  let autoCloseTimer = null;

  function setSlide(index){
    currentIndex = index;
    const offset = -index * 100;
    track.style.transform = `translateX(${offset}%)`;
    dots.forEach((d,i)=>d.classList.toggle("active", i===index));
  }

  dots.forEach(btn=>{
    btn.addEventListener("click",()=>{
      const idx = parseInt(btn.dataset.index,10);
      setSlide(idx);
    });
  });

  function openSheet(){
    sheet.classList.add("active");
    overlay.classList.add("active");
    setSlide(0);

    // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ Ø¨Ø¹Ø¯ 7 Ø«ÙˆØ§Ù†Ù
    if(autoCloseTimer) clearTimeout(autoCloseTimer);
    autoCloseTimer = setTimeout(closeSheet, 7000);
  }

  function closeSheet(){
    sheet.classList.remove("active");
    overlay.classList.remove("active");
    if(autoCloseTimer){
      clearTimeout(autoCloseTimer);
      autoCloseTimer = null;
    }
  }

  if(imgBtn){
    imgBtn.addEventListener("click",openSheet);
  }
  if(closeBtn){
    closeBtn.addEventListener("click",closeSheet);
  }
  overlay.addEventListener("click",closeSheet);
});
</script>
</body>
</html>
