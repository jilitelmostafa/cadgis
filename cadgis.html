<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CartoMaroc Provinces</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: Arial, sans-serif;}
#app {height:100vh; display:flex; flex-direction:column;}
#header {flex-shrink:0; background: linear-gradient(135deg, #E49112 0%, #1B5B9A 100%); color:white; text-align:center; padding:12px 10px; font-size:clamp(14px,4vw,22px); font-weight:bold; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
#content {position:relative; flex:1; overflow:hidden;}
#map {position:absolute; inset:0; width:100%; height:100%;}

#watermark {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:clamp(18px,5vw,32px); font-weight:bold; color:rgba(102,126,234,0.15); pointer-events:none; z-index:1500; white-space:nowrap; text-shadow:2px 2px 4px rgba(255,255,255,0.3);}

.ol-popup {background:linear-gradient(135deg, #ffffff 0%, #f5f7fb 100%); padding:14px 16px; border:1px solid #e0e4ef; min-width:200px; max-width:90vw; z-index:9999; font-size:13px; border-radius:10px; box-shadow:0 10px 25px rgba(15,23,42,0.18); color:#1f2933;}
.ol-popup b {font-size:14px; color:#111827;}
.ol-popup a, .ol-popup button {display:inline-block; margin-top:6px; padding:6px 10px; background:#dc2626; color:#fff; border:none; border-radius:6px; text-decoration:none; font-size:12px; cursor:pointer; margin-right:5px;}
.ol-popup a:hover, .ol-popup button:hover {background:#b91c1c;}
.ol-popup .request-btn {background:#9333ea;}
.ol-popup .request-btn:hover {background:#7e22ce;}
.ol-popup .download-btn {background:#4CAF50;}
.ol-popup .download-btn:hover {background:#388E3C;}

#legend {position:absolute; top:400px; right:10px; background:rgba(255,255,255,0.96); padding:10px 12px; border-radius:10px; box-shadow:0 4px 12px rgba(15,23,42,0.25); z-index:3000; font-size:11px; min-width:135px; max-width:45vw; border:1px solid rgba(148,163,184,0.7); backdrop-filter:blur(4px);}
.legend-item {display:flex; align-items:center; gap:6px; margin-bottom:6px;}
.legend-item:last-child {margin-bottom:0;}
.legend-color {width:16px; height:16px; border:1px solid #000; flex-shrink:0;}

/* ÿ®ÿ≠ÿ´ OSM ŸÖŸÅÿ™Ÿàÿ≠ ÿØÿßÿ¶ŸÖŸãÿß ŸÖÿπ ÿ•ÿ∫ŸÑÿßŸÇ */
#searchContainer {
  position:absolute;
  top:10px; right:10px;
  z-index:2000;
  display:flex;
  flex-direction:column;
}
#searchBoxOSM {
  width:220px;
  padding:6px 10px;
  font-size:13px;
  border-radius:20px;
  border:1px solid #ccc;
  outline:none;
}
#searchBoxOSM:focus {border-color:#2563eb;}
#closeSearch {
  position:absolute;
  top:6px; right:5px;
  font-size:12px;
  cursor:pointer;
  color:#555;
  user-select:none;
}
#showSearchSmall {
  display:none;
  position:absolute;
  top:10px; right:10px;
  z-index:2000;
  font-size:16px;
  cursor:pointer;
  background:#2563eb;
  color:#fff;
  border-radius:50%;
  width:28px; height:28px;
  display:flex; align-items:center; justify-content:center;
}
#suggestions {
  margin-top:2px;
  width:220px;
  max-height:150px;
  overflow-y:auto;
  padding:0;
  list-style:none;
  border:1px solid #ccc;
  background:#fff;
  border-radius:6px;
  display:block;
  font-size:13px;
}
#suggestions li {padding:6px 10px; cursor:pointer;}
#suggestions li:hover {background:#f0f0f0;}
@media (max-width:768px){
  #searchBoxOSM, #suggestions {width:160px;}
}
</style>
</head>
<body>

<div id="app">
<header id="header">
CadGIS | Titres fonciers | Bornes  | Zonage | Limites ADM
</header>

<main id="content">
<div id="map">
<div id="watermark">@CartoMaroc</div>
</div>

<!-- ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÉÿßŸÖŸÑ -->
<div id="searchContainer">
  <input type="text" id="searchBoxOSM" placeholder="üîç Rechercher...">
  <span id="closeSearch">üóô</span>
  <ul id="suggestions"></ul>
</div>

<!-- ÿ£ŸäŸÇŸàŸÜÿ© ŸÑÿ•ÿπÿßÿØÿ© ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´ -->
<div id="showSearchSmall">üîç</div>

<div id="popup" class="ol-popup"></div>

<div id="legend">
<div class="legend-item">
<div class="legend-color" style="background:rgba(76, 175, 80, 0.7);"></div>
<span>Provinces</span>
</div>
<div style="margin-top: 8px; font-size: 10px;">
<span>Email: contact@cartomaroc.com</span>
</div>
</div>
</main>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

const geojsonSource = new ol.source.Vector({
  url:"https://raw.githubusercontent.com/Ayoub-WebGis9/CartoMaroc/main/PROVINCE.geojson",
  format: new ol.format.GeoJSON()
});

function getProvinceName(feature){
  const props = feature.getProperties();
  const possible=["NOM-PROV","NOM_PROV","name","NAME","nom","Nom","ÿßŸÑÿßŸÇŸÑŸäŸÖ","ÿßŸÑÿ•ŸÇŸÑŸäŸÖ"];
  for(let f of possible) if(props[f]) return props[f];
  return "Sans nom";
}

const geojsonLayer = new ol.layer.Vector({
  source:geojsonSource,
  style:function(feature){
    const fillColor="rgba(76, 175, 80, 0.7)";
    return new ol.style.Style({
      stroke:new ol.style.Stroke({color:"black", width:1.3}),
      fill:new ol.style.Fill({color:fillColor}),
      text:new ol.style.Text({
        text:getProvinceName(feature),
        font:"bold 12px Arial",
        fill:new ol.style.Fill({color:"#000"}),
        stroke:new ol.style.Stroke({color:"#fff", width:2})
      })
    });
  }
});

const map=new ol.Map({
  target:"map",
  layers:[
    new ol.layer.Tile({source:new ol.source.OSM()}),
    geojsonLayer
  ],
  view:new ol.View({
    center:ol.proj.fromLonLat([-7.9,31.6]),
    zoom:6
  })
});

const popup=new ol.Overlay({
  element:document.getElementById("popup"),
  positioning:"bottom-center",
  offset:[0,-15]
});
map.addOverlay(popup);

const provinceDownloadLinks = {
  "Fahs-Anjra":"https://cartomaroc.com/data/Fahs-Anjra.zip",
  "Deriouch":"https://cartomaroc.com/data/Deriouch.zip",
  "Moulay Yacoub":"https://cartomaroc.com/data/Moulay-Yacoub.zip",
  "Mediouna":"https://cartomaroc.com/data/Mediouna.zip",
  "Fkih Ben Saleh":"https://cartomaroc.com/data/Fkih-Ben-Saleh.zip",
  "Youssoufia":"https://cartomaroc.com/data/Youssoufia.zip",
  "Inezgane-Ait Melloul":"https://cartomaroc.com/data/Inezgane-Ait-Melloul.zip",
  "Tinghir":"https://cartomaroc.com/data/Tinghir.zip",
  "Sidi Ifni":"https://cartomaroc.com/data/Sidi-Ifni.zip",
  "Tarfaya":"https://cartomaroc.com/data/Tarfaya.zip",
  "Marrakech":"https://cartomaroc.com/data/Marrakech.zip",
  "Tanger-Asilah":"https://cartomaroc.com/data/Tanger-Asilah.zip",
  "Skhirate-Temara":"https://cartomaroc.com/data/Skhirate-Temara.zip",
  "Taza":"https://cartomaroc.com/data/Taza.zip",
  "Settat":"https://cartomaroc.com/data/Settat.zip",
  "Guercif":"https://cartomaroc.com/data/Guercif.zip",
  "M'Diq-Fnideq":"https://cartomaroc.com/data/MDiq-Fnideq.zip",
  "Khouribga":"https://cartomaroc.com/data/Khouribga.zip"
};

window.downloadProvinceData=function(provinceName){
  const link=provinceDownloadLinks[provinceName];
  if(link) window.open(link,"_blank");
  else alert("‚ö†Ô∏è ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ŸÑŸáÿ∞ÿß ÿßŸÑÿ•ŸÇŸÑŸäŸÖ");
};

window.contactWhatsApp=function(provinceName){
  const frenchMessage=`Bonjour, je souhaite recevoir la base de donn√©es compl√®te des Titres, Bornes et Limites pour (*${provinceName}*). Merci !`;
  const arabicMessage=`\nŸÖÿ±ÿ≠ÿ®Ÿãÿßÿå ÿ£ŸàÿØ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿπÿØÿ© ÿßŸÑŸÖÿπÿ∑Ÿäÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÄ:\n(*${provinceName}*)`;
  const message=frenchMessage+arabicMessage;
  const whatsappURL=`https://wa.me/212668090285?text=${encodeURIComponent(message)}`;
  window.open(whatsappURL,"_blank");
};

function showPopup(feature,coord){
  const name=getProvinceName(feature);
  let html=`<b>${name}</b><br>‚ÑπÔ∏è Donn√©es disponibles sur demande<br>`;
  html+=`<button class="request-btn" onclick="downloadProvinceData('${name}')">üì± Demander ces donn√©es</button><br>`;
  html+=`<button class="download-btn" onclick="contactWhatsApp('${name}')">üìû Contacter via WhatsApp</button>`;
  popup.getElement().innerHTML=html;
  popup.setPosition(coord);
}

map.on("click",(evt)=>{
  const f=map.forEachFeatureAtPixel(evt.pixel,ft=>ft);
  if(f) showPopup(f,evt.coordinate);
  else popup.setPosition(undefined);
});

/* ÿßŸÑÿ®ÿ≠ÿ´ OSM ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ ŸÖÿπ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ */
const searchBox=document.getElementById("searchBoxOSM");
const suggestions=document.getElementById("suggestions");
const closeSearch=document.getElementById("closeSearch");
const showSearchSmall=document.getElementById("showSearchSmall");

searchBox.addEventListener("input",function(){
  const query=this.value.trim();
  if(!query){ suggestions.style.display="none"; return; }

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query+', Maroc')}&limit=5`)
    .then(res=>res.json())
    .then(data=>{
      suggestions.innerHTML="";
      if(data.length>0){
        data.forEach(item=>{
          const li=document.createElement("li");
          li.textContent=item.display_name;
          li.addEventListener("click",()=>{
            const lon=parseFloat(item.lon);
            const lat=parseFloat(item.lat);
            map.getView().animate({center:ol.proj.fromLonLat([lon,lat]), zoom:12, duration:1000});
            suggestions.style.display="none";
            searchBox.value=item.display_name;
          });
          suggestions.appendChild(li);
        });
        suggestions.style.display="block";
      } else suggestions.style.display="none";
    }).catch(err=>console.error(err));
});

// ÿ•ÿ∫ŸÑÿßŸÇ ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿµÿ∫Ÿäÿ±ÿ©
closeSearch.addEventListener("click",()=>{
  document.getElementById("searchContainer").style.display="none";
  showSearchSmall.style.display="flex";
});

// ÿ•ÿπÿßÿØÿ© ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿµÿ∫Ÿäÿ±ÿ©
showSearchSmall.addEventListener("click",()=>{
  document.getElementById("searchContainer").style.display="flex";
  showSearchSmall.style.display="none";
});

document.addEventListener("click",function(e){
  if(e.target!==searchBox) suggestions.style.display="none";
});
});
</script>

</body>
</html>
