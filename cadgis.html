<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CadGIS - SystÃ¨me Cadastre Marocain</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #header {
            background: linear-gradient(135deg, #E49112, #1B5B9A);
            color: white; text-align: center; padding: 8px 12px; font-weight: bold;
            font-size: clamp(12px, 3.5vw, 18px); box-shadow: 0 3px 12px rgba(0,0,0,0.2);
            position: relative; z-index: 10; height: 50px; display: flex; align-items: center;
            justify-content: center;
        }
        
        #header-title {
            font-size: clamp(11px, 3vw, 16px); white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; max-width: 70%;
        }
        
        #map { 
            width: 100%; 
            height: calc(100% - 50px); 
            position: relative;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØµØºÙŠØ±Ø© */
        .control-panel {
            position: absolute; z-index: 1000; display: flex; gap: 4px; padding: 4px;
            background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5);
        }
        
        .control-btn {
            width: 42px; height: 42px; border-radius: 50%; border: none;
            font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,1));
        }
        
        .control-btn:hover {
            transform: scale(1.1); box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        
        .control-btn.active { 
            background: linear-gradient(135deg, #E49112, #1B5B9A); color: white; 
        }
        
        /* Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª - ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ù‡Ø§ØªÙ */
        #topControls { 
            display: none; /* Ù…Ø®ÙÙŠØ© */
        }
        
        #bottomControls { 
            bottom: 12px; 
            left: 50%; 
            transform: translateX(-50%); 
        }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .panel {
            position: fixed; background: rgba(255,255,255,0.98); 
            border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 2px solid #1B5B9A; backdrop-filter: blur(15px);
            transform: scale(0.8) translateY(20px); opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 80vh; overflow-y: auto; min-width: 260px;
            z-index: 2000;
        }
        
        .panel.open {
            transform: scale(1) translateY(0); opacity: 1;
        }
        
        #layerPanel { top: 70px; right: 16px; }
        #searchPanel { top: 70px; left: 16px; }
        
        .panel-header {
            padding: 12px 16px; background: linear-gradient(135deg, #1B5B9A, #E49112);
            color: white; font-weight: bold; font-size: 14px; border-radius: 10px 10px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .panel-close {
            background: rgba(255,255,255,0.3); border: none; color: white;
            width: 28px; height: 28px; border-radius: 50%; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        
        .panel-content { padding: 16px; }
        
        .layer-item {
            display: flex; align-items: center; padding: 10px; margin: 6px 0;
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
            font-size: 13px; font-weight: 500;
        }
        
        .layer-item:hover { background: rgba(27,91,154,0.1); }
        .layer-checkbox { 
            margin-left: 10px; width: 18px; height: 18px; 
            accent-color: #E49112; transform: scale(1.1);
        }
        
        #searchInput {
            width: 100%; padding: 12px; border: 2px solid #E0E0E0;
            border-radius: 8px; font-size: 14px; margin-bottom: 12px;
            outline: none; transition: all 0.3s; box-sizing: border-box;
        }
        
        #searchInput:focus { 
            border-color: #E49112; box-shadow: 0 0 0 3px rgba(228,145,18,0.15);
        }
        
        #searchButton {
            width: 100%; padding: 12px; background: linear-gradient(135deg, #E49112, #1B5B9A);
            color: white; border: none; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: all 0.3s;
        }
        
        #searchButton:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(228,145,18,0.4); }
        
        #coords {
            position: absolute; bottom: 12px; right: 12px; padding: 8px 12px;
            background: rgba(255,255,255,0.95); border: 2px solid #1B5B9A;
            border-radius: 20px; font-size: 12px; box-shadow: 0 3px 12px rgba(0,0,0,0.15);
            cursor: pointer; z-index: 1000; transition: all 0.3s; max-width: 220px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        #coords:hover { background: #1B5B9A; color: white; transform: translateY(-2px); }
        
        .popup {
            background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 260px; max-width: 90vw; font-size: 13px; z-index: 3000;
            text-align: right; direction: rtl; border: 2px solid #1B5B9A;
        }
        
        .popup-title {
            font-size: 16px; color: #1e293b; margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 2px solid #E49112; font-weight: bold;
        }
        
        .popup-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .popup-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 13px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        
        .whatsapp-btn { background: #25D366; color: white; }
        .whatsapp-btn:hover { background: #128C7E; transform: translateY(-1px); }
        .email-btn { background: #EA4335; color: white; }
        .email-btn:hover { background: #C23321; transform: translateY(-1px); }
        
        .tooltip {
            position: absolute; background: rgba(0,0,0,0.85); color: white;
            padding: 6px 10px; border-radius: 6px; font-size: 12px;
            pointer-events: none; z-index: 1500; white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ - Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        @media (max-width: 768px) {
            #topControls { display: none !important; }
            #bottomControls { 
                bottom: 16px; left: 50%; transform: translateX(-50%);
                padding: 6px; gap: 6px; background: rgba(255,255,255,0.97);
            }
            .control-btn { width: 44px; height: 44px; font-size: 18px; }
            .panel { 
                min-width: calc(100vw - 40px); max-width: calc(100vw - 40px);
                left: 20px !important; right: 20px !important; top: 80px !important;
            }
            #header { height: 45px; padding: 6px 8px; }
            #header-title { font-size: 11px; max-width: 90%; }
            #coords { font-size: 11px; padding: 6px 10px; max-width: 180px; bottom: 75px; }
        }
        
        @media (max-width: 480px) {
            #bottomControls { flex-wrap: wrap; padding: 8px; gap: 8px; }
            .control-btn { width: 46px; height: 46px; }
            .panel { margin: 0 10px; top: 85px !important; }
        }
        
        /* ÙƒÙ…Ø¨ÙŠÙˆØªØ± - Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        @media (min-width: 769px) {
            #bottomControls { display: none; }
            #topControls { 
                top: 12px; left: 50%; transform: translateX(-50%);
                display: flex !important; padding: 6px;
            }
            .panel { min-width: 280px; }
            #layerPanel { top: 75px; right: 20px; }
            #searchPanel { top: 75px; left: 20px; }
        }
    </style>
</head>
<body>
    <header id="header">
        <div id="header-title">CadGIS - SystÃ¨me Cadastre Marocain</div>
    </header>
    
    <div id="map"></div>
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±) -->
    <div id="topControls" class="control-panel">
        <button id="searchBtn" class="control-btn" title="Recherche">ğŸ”</button>
        <button id="layerBtn" class="control-btn" title="Layers">ğŸ“‹</button>
        <button id="homeBtn" class="control-btn" title="Accueil">ğŸ </button>
    </div>
    
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© (Ù„Ù„Ù‡Ø§ØªÙ) -->
    <div id="bottomControls" class="control-panel">
        <button id="searchBtnMobile" class="control-btn" title="Recherche">ğŸ”</button>
        <button id="layerBtnMobile" class="control-btn" title="Layers">ğŸ“‹</button>
        <button id="homeBtnMobile" class="control-btn" title="Accueil">ğŸ </button>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª -->
    <div id="layerPanel" class="panel">
        <div class="panel-header">
            <span>Layer Control</span>
            <button class="panel-close" onclick="closePanel('layerPanel')">âœ•</button>
        </div>
        <div class="panel-content">
            <div class="layer-item">
                <label class="layer-label">provinces</label>
                <input type="checkbox" id="provinceLayer" checked class="layer-checkbox">
            </div>
            <div class="layer-item">
                <label class="layer-label">titres</label>
                <input type="checkbox" id="titrgeoLayer" checked class="layer-checkbox">
            </div>
            <div class="layer-item">
                <label class="layer-label">Bornes</label>
                <input type="checkbox" id="geoBornesLayer" checked class="layer-checkbox">
            </div>
            <div class="layer-item">
                <label class="layer-label">basemap</label>
                <input type="checkbox" id="baseLayer" checked class="layer-checkbox">
            </div>
        </div>
    </div>
    
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø­Ø« -->
    <div id="searchPanel" class="panel">
        <div class="panel-header">
            <span>Recherche OSM</span>
            <button class="panel-close" onclick="closePanel('searchPanel')">âœ•</button>
        </div>
        <div class="panel-content">
            <input type="text" id="searchInput" placeholder="Adresse, ville, province...">
            <button id="searchButton">Rechercher</button>
        </div>
    </div>
    
    <div id="coords">CoordonnÃ©es: -7.58980, 33.57310</div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <script>
        let map, popup, tooltip, popupEl;
        let selectedProvince = null, selectedTitrgeo = null, selectedGeoBornes = null;
        let layers = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initUI();
            initInteractions();
            initControls();
        });
        
        function openPanel(panelId) {
            closeAllPanels();
            document.getElementById(panelId).classList.add('open');
        }
        
        function closePanel(panelId) {
            document.getElementById(panelId).classList.remove('open');
        }
        
        function closeAllPanels() {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
        }
        
        function initControls() {
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
            document.getElementById('searchBtn').onclick = () => openPanel('searchPanel');
            document.getElementById('layerBtn').onclick = () => openPanel('layerPanel');
            document.getElementById('homeBtn').onclick = goHome;
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('searchBtnMobile').onclick = () => openPanel('searchPanel');
            document.getElementById('layerBtnMobile').onclick = () => openPanel('layerPanel');
            document.getElementById('homeBtnMobile').onclick = goHome;
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.control-panel') && !e.target.closest('.panel')) {
                    closeAllPanels();
                }
            });
        }
        
        async function searchOSM(query) {
            if (!query.trim()) return;
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=ma`
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = data[0];
                    const lon = parseFloat(result.lon);
                    const lat = parseFloat(result.lat);
                    
                    map.getView().animate({
                        center: ol.proj.fromLonLat([lon, lat]),
                        zoom: 16,
                        duration: 1000
                    });
                    
                    closePanel('searchPanel');
                    document.getElementById('searchInput').value = '';
                } else {
                    alert('Aucun rÃ©sultat trouvÃ©');
                }
            } catch (error) {
                alert('Erreur de recherche');
            }
        }
        
        function goHome() {
            closeAllPanels();
            map.getView().animate({
                center: ol.proj.fromLonLat([-7.5898, 33.5731]),
                zoom: 7,
                duration: 800
            });
            if (popup) popup.setPosition(undefined);
            clearSelection();
        }
        
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (initMap, initUI, initInteractions, Ø¥Ù„Ø®) Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
        function initMap() {
            const baseLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                    maxZoom: 20
                })
            });
            
            const provinceSource = new ol.source.Vector({
                url: 'https://raw.githubusercontent.com/jilitelmostafa/decoupage_prov_maroc/refs/heads/main/PROVINCE.geojson.txt',
                format: new ol.format.GeoJSON()
            });
            
            const titrgeoSource = new ol.source.Vector({
                url: 'https://raw.githubusercontent.com/jilitelmostafa/decoupage_prov_maroc/refs/heads/main/titrgeo.txt',
                format: new ol.format.GeoJSON()
            });
            
            const geoBornesSource = new ol.source.Vector({
                url: 'https://raw.githubusercontent.com/jilitelmostafa/decoupage_prov_maroc/refs/heads/main/geoBornes.txt',
                format: new ol.format.GeoJSON()
            });
            
            const provinceLayer = new ol.layer.Vector({
                source: provinceSource,
                style: feature => {
                    const name = feature.get('NOM_PROV') || feature.get('NAME') || feature.get('nom') || '';
                    const isSelected = feature === selectedProvince;
                    const isTaroudant = name.toLowerCase().includes('taroudant');
                    
                    const fillColor = isSelected ? 'rgba(255, 215, 0, 0.4)' :
                        (isTaroudant ? 'rgba(0, 200, 83, 0.3)' : 'rgba(30, 144, 255, 0.2)');
                    const strokeColor = isSelected ? '#FF5722' :
                        (isTaroudant ? '#00C853' : '#00FF40');
                    
                    return [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({ color: strokeColor, width: isSelected ? 4 : 2 }),
                            fill: new ol.style.Fill({ color: fillColor })
                        }),
                        name && new ol.style.Style({
                            text: new ol.style.Text({
                                text: name.length > 20 ? name.substring(0, 20) + '...' : name,
                                font: isSelected ? 'bold 14px Arial' : 'bold 12px Arial',
                                fill: new ol.style.Fill({ color: isSelected ? '#FF5722' : '#1B5B9A' }),
                                stroke: new ol.style.Stroke({ color: 'rgba(255,255,255,0.9)', width: 3 })
                            })
                        })
                    ].filter(Boolean);
                }
            });
            
            const titrgeoLayer = new ol.layer.Vector({
                source: titrgeoSource,
                style: feature => {
                    const name = feature.get('tit_com') || '';
                    const isSelected = feature === selectedTitrgeo;
                    return [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({ 
                                color: isSelected ? '#FF9800' : '#D32F2F', 
                                width: isSelected ? 4 : 2 
                            }),
                            fill: new ol.style.Fill({
                                color: isSelected ? 'rgba(255,152,0,0.3)' : 'rgba(211,47,47,0.1)'
                            })
                        }),
                        name && new ol.style.Style({
                            text: new ol.style.Text({
                                text: name.length > 25 ? name.substring(0, 25) + '...' : name,
                                font: isSelected ? 'bold 13px Arial' : '12px Arial',
                                fill: new ol.style.Fill({ color: '#FFFFFF' }),
                                stroke: new ol.style.Stroke({ color: 'rgba(0,0,0,0.7)', width: 2 }),
                                backgroundFill: new ol.style.Fill({ color: 'rgba(211,47,47,0.7)' }),
                                padding: [2, 4, 2, 4]
                            })
                        })
                    ].filter(Boolean);
                }
            });
            
            const geoBornesLayer = new ol.layer.Vector({
                source: geoBornesSource,
                style: feature => {
                    const name = feature.get('name') || feature.get('nom') || '';
                    const isSelected = feature === selectedGeoBornes;
                    return [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({ 
                                color: isSelected ? '#9C27B0' : '#303F9F', 
                                width: isSelected ? 4 : 2 
                            }),
                            fill: new ol.style.Fill({
                                color: isSelected ? 'rgba(156,39,176,0.3)' : 'rgba(48,63,159,0.15)'
                            })
                        }),
                        name && new ol.style.Style({
                            text: new ol.style.Text({
                                text: name.length > 25 ? name.substring(0, 25) + '...' : name,
                                font: isSelected ? 'bold 13px Arial' : '12px Arial',
                                fill: new ol.style.Fill({ color: '#303F9F' }),
                                stroke: new ol.style.Stroke({ color: 'rgba(255,255,255,0.8)', width: 2 })
                            })
                        })
                    ].filter(Boolean);
                }
            });
            
            layers = [baseLayer, provinceLayer, titrgeoLayer, geoBornesLayer];
            
            map = new ol.Map({
                target: 'map',
                layers: layers,
                view: new ol.View({
                    center: ol.proj.fromLonLat([-7.5898, 33.5731]),
                    zoom: 7,
                    minZoom: 4,
                    maxZoom: 19
                })
            });
            
            map.addControl(new ol.control.ScaleLine({
                units: 'metric', bar: true, steps: 4, minWidth: 120
            }));
        }
        
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙƒÙ…Ø§ Ù‡ÙŠ...
        function initUI() {
            popupEl = document.createElement('div');
            popupEl.className = 'popup';
            popup = new ol.Overlay({
                element: popupEl, positioning: 'bottom-center', offset: [0, -10], stopEvent: true
            });
            map.addOverlay(popup);
            
            tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            document.body.appendChild(tooltip);
            
            window.requestWhatsapp = name => window.open(`https://wa.me/212668090285?text=Info ${name}`, '_blank');
            window.requestEmail = name => window.open(`mailto:info@cadgis.ma?subject=Info ${name}`, '_blank');
        }
        
        function initInteractions() {
            const coordsEl = document.getElementById('coords');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            
            document.getElementById('provinceLayer').onchange = e => layers[1].setVisible(e.target.checked);
            document.getElementById('titrgeoLayer').onchange = e => layers[2].setVisible(e.target.checked);
            document.getElementById('geoBornesLayer').onchange = e => layers[3].setVisible(e.target.checked);
            document.getElementById('baseLayer').onchange = e => layers[0].setVisible(e.target.checked);
            
            searchButton.onclick = () => searchOSM(searchInput.value);
            searchInput.onkeypress = e => e.key === 'Enter' && searchOSM(searchInput.value);
            
            map.on('pointermove', evt => {
                const coord = ol.proj.toLonLat(evt.coordinate);
                coordsEl.textContent = `CoordonnÃ©es: ${coord[0].toFixed(5)}, ${coord[1].toFixed(5)}`;
                
                const feature = map.forEachFeatureAtPixel(evt.pixel, ft => ft);
                if (feature) {
                    map.getTargetElement().style.cursor = 'pointer';
                    const name = feature.get('NOM_PROV') || feature.get('tit_com') || feature.get('name') || feature.get('nom') || '';
                    if (name) {
                        tooltip.textContent = name.length > 25 ? name.substring(0, 25) + '...' : name;
                        tooltip.style.left = evt.pixel[0] + 'px';
                        tooltip.style.top = evt.pixel[1] - 20 + 'px';
                        tooltip.style.display = 'block';
                    }
                } else {
                    map.getTargetElement().style.cursor = '';
                    tooltip.style.display = 'none';
                }
            });
            
            map.on('click', evt => {
                tooltip.style.display = 'none';
                const feature = map.forEachFeatureAtPixel(evt.pixel, ft => ft);
                if (feature) {
                    clearSelection();
                    updateSelection(feature);
                    showFeatureInfo(feature, evt.coordinate);
                } else {
                    if (popup) popup.setPosition(undefined);
                    clearSelection();
                }
            });
            
            coordsEl.onclick = () => {
                const center = ol.proj.toLonLat(map.getView().getCenter());
                navigator.clipboard.writeText(`${center[0].toFixed(6)}, ${center[1].toFixed(6)}`).then(() => {
                    const original = coordsEl.textContent;
                    coordsEl.textContent = 'CopiÃ©!';
                    setTimeout(() => coordsEl.textContent = original, 1500);
                });
            };
        }
        
        function updateSelection(feature) {
            clearSelection();
            if (layers[1] && layers[1].getSource().hasFeature(feature)) selectedProvince = feature;
            else if (layers[2] && layers[2].getSource().hasFeature(feature)) selectedTitrgeo = feature;
            else if (layers[3] && layers[3].getSource().hasFeature(feature)) selectedGeoBornes = feature;
            if (map) map.render();
        }
        
        function clearSelection() {
            selectedProvince = selectedTitrgeo = selectedGeoBornes = null;
            if (map) map.render();
        }
        
        function showFeatureInfo(feature, coord) {
            let name = '', details = {};
            if (layers[1] && layers[1].getSource().hasFeature(feature)) {
                name = feature.get('NOM_PROV') || 'Province';
                details = { 'Type': 'Province', 'Nom': name, 'Code': feature.get('code') || 'N/A' };
            } else if (layers[2] && layers[2].getSource().hasFeature(feature)) {
                name = feature.get('tit_com') || 'Titre';
                details = { 'Type': 'Titre foncier', 'NumÃ©ro': feature.get('num') || 'N/A' };
            } else {
                name = feature.get('name') || 'Borne';
                details = { 'Type': 'Borne', 'Nom': name };
            }
            
            popupEl.innerHTML = `
                <div class="popup-title">${name}</div>
                ${Object.entries(details).map(([k,v]) => `<div>${k}: <b>${v}</b></div>`).join('')}
                <div class="popup-buttons">
                    <button class="popup-btn whatsapp-btn" onclick="requestWhatsapp('${name}')">ğŸ“± WhatsApp</button>
                    <button class="popup-btn email-btn" onclick="requestEmail('${name}')">âœ‰ï¸ Email</button>
                </div>
            `;
            popup.setPosition(coord);
        }
    </script>
</body>
</html>
